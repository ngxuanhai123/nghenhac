<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HiHi - YouTube Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #0f0f0f;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #header {
            background-color: #181818;
            padding: 12px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
            flex-shrink: 0;
        }

        #logo {
            font-size: 18px;
            font-weight: bold;
            color: #ff0000;
            white-space: nowrap;
        }

        #badges {
            display: flex;
            gap: 6px;
            font-size: 9px;
            font-weight: bold;
        }

        .badge {
            background-color: #1a3a1a;
            border: 1px solid #2d6d2d;
            color: #5dff5d;
            padding: 4px 6px;
            border-radius: 3px;
            white-space: nowrap;
        }

        #search-container {
            flex: 1;
            display: flex;
            gap: 0;
        }

        #videoInput {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #303030;
            border-radius: 20px 0 0 20px;
            background-color: #212121;
            color: #fff;
            font-size: 12px;
            outline: none;
            min-width: 0;
        }

        #videoInput:focus {
            background-color: #2a2a2a;
            border-color: #555;
        }

        #playBtn {
            background-color: #ff0000;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 0 20px 20px 0;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #playBtn:active {
            background-color: #cc0000;
        }

        #playBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #app {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #playerContainer {
            background-color: #000;
            aspect-ratio: 16/9;
            flex-shrink: 0;
            width: 100%;
            position: relative;
        }

        #player {
            width: 100%;
            height: 100%;
        }

        #playerControls {
            background-color: #1a1a1a;
            padding: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-top: 1px solid #303030;
            flex-wrap: wrap;
        }

        .control-btn {
            background-color: #303030;
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .control-btn:active {
            background-color: #404040;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn.download {
            background-color: #1a3a1a;
            border: 1px solid #2d6d2d;
            color: #5dff5d;
        }

        .control-btn.download:active {
            background-color: #2d5d2d;
        }

        #content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            -webkit-overflow-scrolling: touch;
        }

        #content::-webkit-scrollbar {
            width: 6px;
        }

        #content::-webkit-scrollbar-track {
            background: #181818;
        }

        #content::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 3px;
        }

        .info-box {
            background-color: #1a2a1a;
            border: 1px solid #2d5d2d;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 11px;
            color: #aaa;
            line-height: 1.6;
        }

        .info-box strong {
            color: #5dff5d;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            margin: 15px 0 10px 0;
            color: #aaa;
            text-transform: uppercase;
        }

        .video-card {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .video-card:active {
            background-color: #252525;
        }

        .video-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .video-id {
            font-size: 11px;
            color: #666;
        }

        .status {
            font-size: 11px;
            color: #aaa;
            margin-top: 8px;
            padding: 8px;
            background-color: #181818;
            border-radius: 4px;
        }

        .error {
            background-color: #2a1a1a;
            border: 1px solid #8b3a3a;
            color: #ff9999;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 11px;
        }

        @media (max-width: 600px) {
            #header {
                padding: 8px;
                gap: 6px;
            }

            #logo {
                font-size: 16px;
            }

            #badges {
                gap: 4px;
            }

            .badge {
                font-size: 8px;
                padding: 2px 4px;
            }

            #videoInput {
                font-size: 11px;
                padding: 6px 10px;
            }

            #playBtn {
                padding: 6px 10px;
                font-size: 12px;
            }

            #playerControls {
                padding: 8px;
                gap: 6px;
            }

            .control-btn {
                padding: 5px 8px;
                font-size: 10px;
            }
        }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <div id="header">
        <div id="logo">‚ô´ HiHi</div>
        <div id="badges">
            <div class="badge">üö´ NO ADS</div>
            <div class="badge">üì• DOWNLOAD</div>
        </div>
        <div id="search-container">
            <input id="videoInput" type="text" placeholder="Video ID ho·∫∑c URL...">
            <button id="playBtn">‚ñ∂</button>
        </div>
    </div>

    <div id="app">
        <div id="playerContainer">
            <div id="player"></div>
        </div>

        <div id="playerControls">
            <button class="control-btn" id="prevBtn">‚èÆ -10s</button>
            <button class="control-btn" id="playPauseBtn">‚è∏ D·ª´ng</button>
            <button class="control-btn" id="nextBtn">+10s ‚è≠</button>
            <button class="control-btn download" id="downloadBtn" disabled>üì• Download</button>
            <button class="control-btn" id="infoBtn">‚ÑπÔ∏è Info</button>
        </div>

        <div id="content">
            <div class="info-box">
                <strong>‚ÑπÔ∏è NewPipe Web:</strong><br>
                ‚úì Xem YouTube kh√¥ng qu·∫£ng c√°o<br>
                ‚úì Download video/audio<br>
                ‚úì Nghe khi t·∫Øt m√†n h√¨nh
            </div>

            <div class="section-title">üì∫ Video ph·ªï bi·∫øn</div>
            <div class="video-card" onclick="playVideo('dQw4w9WgXcQ')">
                <div class="video-title">‚ñ∂ Rick Astley - Never Gonna Give You Up</div>
                <div class="video-id">dQw4w9WgXcQ</div>
            </div>
            <div class="video-card" onclick="playVideo('kJQP7kiw9Fk')">
                <div class="video-title">‚ñ∂ Luis Fonsi - Despacito</div>
                <div class="video-id">kJQP7kiw9Fk</div>
            </div>
            <div class="video-card" onclick="playVideo('9bZkp7q19f0')">
                <div class="video-title">‚ñ∂ PSY - GANGNAM STYLE</div>
                <div class="video-id">9bZkp7q19f0</div>
            </div>
            <div class="video-card" onclick="playVideo('CvBfHwUxHIg')">
                <div class="video-title">‚ñ∂ Adele - Hello</div>
                <div class="video-id">CvBfHwUxHIg</div>
            </div>
            <div class="video-card" onclick="playVideo('5Zs-TXdXWcQ')">
                <div class="video-title">‚ñ∂ Wiz Khalifa - See You Again</div>
                <div class="video-id">5Zs-TXdXWcQ</div>
            </div>

            <div class="section-title">üéµ Nh·∫°c hay</div>
            <div class="video-card" onclick="playVideo('OPf0YbXqDm0')">
                <div class="video-title">‚ñ∂ Uptown Funk - Mark Ronson</div>
                <div class="video-id">OPf0YbXqDm0</div>
            </div>

            <div id="status"></div>
        </div>
    </div>

    <script>
        let player = null;
        let sponsorSegments = [];
        let skipInterval = null;
        let currentVideoId = '';
        let currentVideoTitle = '';
        let ytReady = false;

        window.onYouTubeIframeAPIReady = function() {
            console.log('‚úì YouTube API Ready');
            ytReady = true;
        };

        function ensureYTReady() {
            return new Promise((resolve) => {
                if (ytReady) {
                    resolve();
                } else {
                    const check = setInterval(() => {
                        if (window.YT && window.YT.Player) {
                            ytReady = true;
                            clearInterval(check);
                            resolve();
                        }
                    }, 100);
                    setTimeout(() => {
                        clearInterval(check);
                        resolve();
                    }, 5000);
                }
            });
        }

        function playVideo(videoId, title = '') {
            if (!videoId.trim()) return;

            let id = videoId.trim();
            
            // Parse URL
            if (id.includes('youtube.com')) {
                const match = id.match(/v=([a-zA-Z0-9_-]{11})/);
                id = match ? match[1] : id;
            } else if (id.includes('youtu.be')) {
                const match = id.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
                id = match ? match[1] : id;
            }

            currentVideoId = id;
            currentVideoTitle = title || `Video ${id.substring(0, 8)}`;
            document.getElementById('videoInput').value = id;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('playBtn').textContent = '‚è≥ T·∫£i...';

            ensureYTReady().then(() => {
                if (!player && window.YT && window.YT.Player) {
                    player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: id,
                    playerVars: {
                        autoplay: 1,
                        controls: 1,
                        rel: 0,
                        modestbranding: 1,
                        playsinline: 1,
                        fs: 1,
                        iv_load_policy: 3
                    },
                    events: {
                        onReady: onPlayerReady,
                        onStateChange: onPlayerStateChange
                    }
                                    });
                } else if (player) {
                    player.loadVideoById(id);
                }

                // Fetch sponsor segments
                fetchSponsorSegments(id);
                
                // Enable download button
                document.getElementById('downloadBtn').disabled = false;
            });
        }

        function onPlayerReady(event) {
            console.log('‚úì Player Ready');
            event.target.playVideo();
            document.getElementById('playBtn').disabled = false;
            document.getElementById('playBtn').textContent = '‚ñ∂ Ph√°t';
            blockAds();
        }

        function onPlayerStateChange(event) {
            const states = {
                [-1]: 'Kh√¥ng kh·ªüi t·∫°o',
                0: 'K·∫øt th√∫c',
                1: 'ƒêang ph√°t',
                2: 'T·∫°m d·ª´ng',
                3: 'Buffering',
                5: 'G·ª£i √Ω video'
            };

            if (event.data === YT.PlayerState.PLAYING) {
                document.getElementById('playPauseBtn').textContent = '‚è∏ D·ª´ng';
                if (!skipInterval) {
                    skipInterval = setInterval(autoSkipSponsors, 200);
                }
                blockAds();
                // Gi·ªØ Audio Context ƒë·ªÉ √¢m thanh ph√°t khi t·∫Øt m√†n h√¨nh
                keepAudioActive();
                showStatus(`‚ñ∂ ${currentVideoTitle}`);
            } else if (event.data === YT.PlayerState.PAUSED) {
                document.getElementById('playPauseBtn').textContent = '‚ñ∂ Ph√°t';
                if (skipInterval) {
                    clearInterval(skipInterval);
                    skipInterval = null;
                }
            }
        }

        // Gi·ªØ audio ho·∫°t ƒë·ªông khi t·∫Øt m√†n h√¨nh
        function keepAudioActive() {
            try {
                // T·∫°o Audio Context ƒë·ªÉ gi·ªØ audio session ho·∫°t ƒë·ªông
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                // T·∫°o oscillator √¢m thanh y·∫øu (kh√¥ng nghe ƒë∆∞·ª£c) ƒë·ªÉ gi·ªØ session
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                gain.gain.setValueAtTime(0, audioContext.currentTime); // Volume = 0
                osc.start();
                setTimeout(() => osc.stop(), 1000);
                console.log('‚úì Audio context activated');
            } catch (err) {
                console.log('Audio context:', err.message);
            }
        }

        // X·ª≠ l√Ω khi tab b·ªã ·∫©n
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Tab hi·ªÉn th·ªã l·∫°i - ti·∫øp t·ª•c ph√°t
                if (player && player.getPlayerState) {
                    ensureYTReady().then(() => {
                        setTimeout(() => {
                            const state = player.getPlayerState();
                            console.log('Current state:', state);
                            if (state !== YT.PlayerState.PLAYING) {
                                player.playVideo();
                                console.log('‚ñ∂ Ti·∫øp t·ª•c ph√°t sau khi b·∫≠t tab');
                            }
                        }, 500);
                    });
                }
            } else {
                // Tab ·∫©n - ghi l·∫°i state
                console.log('üì± Tab ·∫©n');
                keepAudioActive();
            }
        });

        // Ki·ªÉm tra ƒë·ªãnh k·ª≥ n·∫øu video b·ªã d·ª´ng
        setInterval(() => {
            if (document.hidden && player && player.getPlayerState) {
                const state = player.getPlayerState();
                // N·∫øu video b·ªã d·ª´ng khi tab ·∫©n, ph√°t l·∫°i
                if (state === YT.PlayerState.PAUSED) {
                    console.log('‚ö†Ô∏è Video d·ª´ng ·ªü background, ph√°t l·∫°i');
                    player.playVideo();
                    keepAudioActive();
                }
            }
        }, 3000);

        function blockAds() {
            try {
                const style = document.createElement('style');
                style.textContent = `
                    [data-ad-layout] { display: none !important; }
                    [data-ad-format] { display: none !important; }
                    .ytp-ad-overlay-slot { display: none !important; }
                    .ytp-ad-player-overlay { display: none !important; }
                    .ytp-ad-action-interstitial-container { display: none !important; }
                `;
                if (!document.querySelector('style[data-ads]')) {
                    style.setAttribute('data-ads', 'true');
                    document.head.appendChild(style);
                }
                console.log('‚úì Ads blocked');
            } catch (e) {
                console.log('Ad block error:', e.message);
            }
        }

        function fetchSponsorSegments(videoId) {
            // SponsorBlock b·ªã v√¥ hi·ªáu h√≥a
            sponsorSegments = [];
            console.log('‚úì SponsorBlock disabled');
        }

        function autoSkipSponsors() {
            if (!player || !player.getCurrentTime) return;

            const current = player.getCurrentTime();
            for (let seg of sponsorSegments) {
                if (!seg.skipped && current >= seg.start && current < seg.end) {
                    player.seekTo(seg.end, true);
                    seg.skipped = true;
                    console.log(`‚è© B·ªè qua ${seg.type}: ${seg.start.toFixed(1)}s - ${seg.end.toFixed(1)}s`);
                    break;
                }
            }
        }

        function showStatus(msg) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="status">‚è±Ô∏è ${msg}</div>`;
        }

        // Controls
        document.getElementById('playBtn').addEventListener('click', () => {
            playVideo(document.getElementById('videoInput').value);
        });

        document.getElementById('videoInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                playVideo(document.getElementById('videoInput').value);
            }
        });

        document.getElementById('playPauseBtn').addEventListener('click', () => {
            if (!player) return;
            ensureYTReady().then(() => {
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                } else {
                    player.playVideo();
                }
            });
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (player) {
                ensureYTReady().then(() => {
                    player.seekTo(player.getCurrentTime() - 10, true);
                });
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (player) {
                ensureYTReady().then(() => {
                    player.seekTo(player.getCurrentTime() + 10, true);
                });
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!currentVideoId) return;
            alert(`üì• Download:\nhttps://www.youtube.com/watch?v=${currentVideoId}\n\nD√πng c√¥ng c·ª• b√™n ngo√†i ƒë·ªÉ t·∫£i (yt-dlp, youtube-dl)`);
        });

        document.getElementById('infoBtn').addEventListener('click', () => {
            alert(`‚ÑπÔ∏è NewPipe Web\n\nVideo: ${currentVideoTitle}\nID: ${currentVideoId}\n\nT√≠nh nƒÉng:\n‚úì Kh√¥ng qu·∫£ng c√°o\n‚úì Skip -/+ 10s\n‚úì Nghe khi t·∫Øt m√†n h√¨nh`);
        });

        // Load YouTube API
        function loadYouTubeAPI() {
            if (window.YT && window.YT.Player) {
                ytReady = true;
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://www.youtube.com/iframe_api';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadYouTubeAPI();
            showStatus('‚úì NewPipe Web s·∫µn s√†ng');
        });

        window.playVideo = playVideo;
    </script>
</body>
</html>
